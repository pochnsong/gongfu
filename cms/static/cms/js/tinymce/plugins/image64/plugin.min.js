tinymce.PluginManager.add('image64', function(editor, url) {

    function selectImage() {
        var _picker_id = 'plugin-img-picker';
        var picker = document.getElementById(_picker_id);
        if (picker == null) {
            picker = document.createElement('input');
            picker.setAttribute('id', _picker_id);
            picker.setAttribute('type', 'file');
            picker.setAttribute('accept', 'image/*');
            document.body.appendChild(picker);
            picker.setAttribute("style", 'visibility:hidden');
        }

        picker.click();
        $("#" + _picker_id).change(function(e) {

            var file = e.target.files || e.dataTransfer.files;
            if (file) {
                var reader = new FileReader();
                reader.onload = function() {
                    console.log("onload", reader)
                    //图片压缩
                    var compressed_image;
                    if (file[0].size / 1024 > 1024) {
                        var img = new Image();
                        img.src = this.result;
                        var cvs = document.createElement('canvas');
                        //naturalWidth真实图片的宽度
                        cvs.width = img.width;
                        cvs.height = img.height;
                        var ctx = cvs.getContext("2d").drawImage(img, 0, 0);
                        var newImageData = cvs.toDataURL('image/jpeg', 20/100);
                        compressed_image = newImageData;
                    } else {
                        compressed_image = this.result;
                    }
                    editor.insertContent("<img style='max-width:100%;' src='" + compressed_image + "'/>");
                    $('#' + _picker_id).remove()
                }
                reader.readAsDataURL(file[0]);
            }
        });
    }

    // 工具栏
    editor.addButton('image64', {
        text: '插入本地图片',
        icon: 'image',
        onclick: selectImage
    });

    // 菜单栏
    editor.addMenuItem('image64', {
        text: '插入本地图片',
        icon: 'image',
        context: 'insert',
        onclick: selectImage
    });
});